<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Line è¡¨æƒ…è²¼è‡ªå‹•åŒ–åŠ©æ‰‹ - Meikoå¾®èª²é »é“</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #0f172a; /* Slate 900 */
            color: #f8fafc;
        }

        /* Rebranded to Orange (#F97316) */
        .text-line { color: #F97316; }
        .bg-line { background-color: #F97316; }
        .bg-line:hover { background-color: #EA580C; } 
        .border-line { border-color: #F97316; }
        .ring-line { --tw-ring-color: #F97316; }
        
        /* Official LINE Green for external link button */
        .bg-line-official { background-color: #06C755; }
        .bg-line-official:hover { background-color: #05b34c; }

        /* YouTube Red */
        .bg-youtube { background-color: #FF0000; }
        .bg-youtube:hover { background-color: #CC0000; }

        .grid-bg { 
            background-image: linear-gradient(45deg, #334155 25%, transparent 25%), 
                              linear-gradient(-45deg, #334155 25%, transparent 25%), 
                              linear-gradient(45deg, transparent 75%, #334155 75%), 
                              linear-gradient(-45deg, transparent 75%, #334155 75%);
            background-size: 16px 16px;
            background-position: 0 0, 0 8px, 8px -8px, -8px 0px;
            background-color: #1e293b;
        }

        .step-card { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .custom-radio:checked + div {
            border-color: #F97316;
            background-color: rgba(249, 115, 22, 0.1);
            color: #F97316;
            font-weight: 700;
        }
        input[type="range"] { accent-color: #F97316; }
        .btn-press:active { transform: scale(0.98); }
        
        /* Fixed 8x5 Grid Overlay */
        .align-grid {
            pointer-events: none;
            border: 2px solid rgba(249, 115, 22, 0.9);
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            background-image: 
                linear-gradient(to right, rgba(249, 115, 22, 0.5) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(249, 115, 22, 0.5) 1px, transparent 1px);
            background-size: 12.5% 20%; 
        }
        
        /* Custom Scrollbar for Prompt Box */
        .scrollbar-thin::-webkit-scrollbar { width: 8px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #1e293b; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Syntax Highlighting Classes */
        /* Changed var-highlight to Orange (#F97316) to match theme */
        .var-highlight { color: #F97316; font-weight: bold; background-color: rgba(249, 115, 22, 0.1); padding: 0 4px; border-radius: 4px; }
        /* Fixed values kept as Blue (#38bdf8) */
        .fixed-val { font-weight: bold; color: #38bdf8; } 
        .section-title { color: #fbbf24; font-weight: bold; margin-top: 1rem; margin-bottom: 0.5rem; display: block; border-bottom: 1px solid #334155; padding-bottom: 0.25rem; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- Icons ---
        const Icon = ({ children, className, spin, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={`${className || ''} ${spin ? 'animate-spin' : ''}`} {...props}>{children}</svg>
        );
        const IconUpload = (props) => <Icon {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></Icon>;
        const IconScissors = (props) => <Icon {...props}><circle cx="6" cy="6" r="3"/><path d="M8.12 8.12 12 12"/><path d="M20 4 8.12 15.88"/><circle cx="6" cy="18" r="3"/><path d="M14.8 14.8 20 20"/></Icon>;
        const IconDownload = (props) => <Icon {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></Icon>;
        const IconLoader = (props) => <Icon {...props} spin><path d="M21 12a9 9 0 1 1-6.219-8.56"/></Icon>;
        const IconEraser = (props) => <Icon {...props}><path d="m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21"/><path d="M22 21H7"/><path d="m5 11 9 9"/></Icon>;
        const IconCheckCircle = (props) => <Icon {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></Icon>;
        const IconMessageCircle = (props) => <Icon {...props}><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></Icon>;
        const IconHash = (props) => <Icon {...props}><line x1="4" x2="20" y1="9" y2="9"/><line x1="4" x2="20" y1="15" y2="15"/><line x1="10" x2="8" y1="3" y2="21"/><line x1="16" x2="14" y1="3" y2="21"/></Icon>;
        const IconMoon = (props) => <Icon {...props}><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></Icon>;
        const IconSettings = (props) => <Icon {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.72l-.15.1a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.72l.15-.1a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></Icon>;
        const IconChevronDown = (props) => <Icon {...props}><path d="m6 9 6 6 6-6"/></Icon>;
        const IconCopy = (props) => <Icon {...props}><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></Icon>;
        const IconWand2 = (props) => <Icon {...props}><path d="m21.64 3.64-1.28-1.28a1.21 1.21 0 0 0-1.72 0L2.36 18.64a1.21 1.21 0 0 0 0 1.72l1.28 1.28a1.2 1.2 0 0 0 1.72 0L21.64 5.36a1.2 1.2 0 0 0 0-1.72Z"/><path d="m14 7 3 3"/><path d="M5 6v4"/><path d="M19 14v4"/><path d="M10 2v2"/><path d="M7 8H3"/><path d="M21 16h-4"/><path d="M11 3H9"/></Icon>;
        const IconStar = (props) => <Icon {...props}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></Icon>;
        const IconTag = (props) => <Icon {...props}><path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"/><path d="M7 7h.01"/></Icon>;
        const IconCrop = (props) => <Icon {...props}><path d="M6.13 1L6 16a2 2 0 0 0 2 2h15"/><path d="M1 6.13L16 6a2 2 0 0 1 2 2v15"/></Icon>;
        const IconInfo = (props) => <Icon {...props}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></Icon>;
        const IconMove = (props) => <Icon {...props}><polyline points="5 9 2 12 5 15"/><polyline points="9 5 12 2 15 5"/><polyline points="15 19 12 22 9 19"/><polyline points="19 15 22 12 19 9"/><line x1="2" x2="22" y1="12" y2="12"/><line x1="12" x2="12" y1="2" y2="22"/></Icon>;
        const IconGrid = (props) => <Icon {...props}><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M3 9h18"/><path d="M9 21V3"/></Icon>;
        const IconSun = (props) => <Icon {...props}><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></Icon>;
        const IconEdit = (props) => <Icon {...props}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></Icon>;
        const IconPalette = (props) => <Icon {...props}><circle cx="13.5" cy="6.5" r=".5"/><circle cx="17.5" cy="10.5" r=".5"/><circle cx="8.5" cy="7.5" r=".5"/><circle cx="6.5" cy="12.5" r=".5"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"/></Icon>;
        const IconExternalLink = (props) => <Icon {...props}><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" x2="21" y1="14" y2="3"/></Icon>;
        const IconYoutube = (props) => <Icon {...props}><path d="M2.5 17a24.12 24.12 0 0 1 0-10 2 2 0 0 1 1.4-1.4 49.56 49.56 0 0 1 16.2 0A2 2 0 0 1 21.5 7a24.12 24.12 0 0 1 0 10 2 2 0 0 1-1.4 1.4 49.55 49.55 0 0 1-16.2 0A2 2 0 0 1 2.5 17"/><path d="m10 15 5-3-5-3z"/></Icon>;

        // --- Logo ---
        const logoSrc = "https://rain-galley-248.notion.site/image/attachment%3A1a4404e1-e6b1-4f29-a495-123224c6135a%3AMeiko_logo.png?table=block&id=2c04c228-35e5-80d2-b534-f270fb01613d&spaceId=cf48a189-fd68-4fe6-a35c-bf6538001b35&width=770&userId=&cache=v2";

        // --- WEB WORKER CODE ---
        const workerScript = `
        self.onmessage = function(e) {
            const { imageBitmap, id, targetColor, tolerance, smoothness, despill } = e.data;
            const w = imageBitmap.width;
            const h = imageBitmap.height;
            const canvas = new OffscreenCanvas(w, h);
            const ctx = canvas.getContext('2d');
            ctx.drawImage(imageBitmap, 0, 0);
            const imgData = ctx.getImageData(0, 0, w, h);
            const data = imgData.data;
            const tr = parseInt(targetColor.slice(1, 3), 16);
            const tg = parseInt(targetColor.slice(3, 5), 16);
            const tb = parseInt(targetColor.slice(5, 7), 16);
            const distThreshold = tolerance * 4.42; 
            const ramp = Math.max(1, smoothness * 5); 
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                const dist = Math.sqrt((r - tr) * (r - tr) + (g - tg) * (g - tg) + (b - tb) * (b - tb));
                let alpha = 255;
                if (dist < distThreshold) alpha = 0; 
                else if (dist < distThreshold + ramp) alpha = ((dist - distThreshold) / ramp) * 255;
                if (despill && alpha > 0) {
                    if (targetColor.toLowerCase() === '#00ff00') {
                        if (g > r && g > b) data[i+1] = (r + b) / 2; 
                    }
                }
                data[i + 3] = alpha;
            }
            ctx.putImageData(imgData, 0, 0);
            canvas.convertToBlob({ type: 'image/png' }).then(blob => {
                const reader = new FileReader();
                reader.readAsDataURL(blob);
                reader.onloadend = () => self.postMessage({ id, dataUrl: reader.result });
            });
        };
        `;

        const blob = new Blob([workerScript], { type: "text/javascript" });
        const workerUrl = URL.createObjectURL(blob);

        // --- CONSTANTS ---
        const COLS = 8;
        const ROWS = 5;
        const TOTAL_ITEMS = COLS * ROWS; // 40

        // --- PROMPT DATA (Expanded to 40 items each) ---
        const PROMPT_THEMES = {
            daily: { 
                label: 'æ—¥å¸¸ç”¨èª', 
                texts: 'æ—©å®‰, æ™šå®‰, è¬å•¦, å…å®¢æ°£, æŠ±æ­‰, å¥½çš„, æ”¶åˆ°, æ‹œè¨—, è¾›è‹¦, OK, ç­‰ç­‰, æ²’äº‹, Bye, Yes, No, Hi, Thx, åŠ æ²¹, æ­å–œ, è®š, å“ˆ, å˜», å—š, å”‰, å“¼, å’¦, å–”, å—¯, å˜¿, å“‡, æ»¾, ä¾†, å», ä¹–, æ£’, æšˆ, ç´¯, å¿™, é–’, ç¡', 
                action_list: `Row 1 (åŸºæœ¬äº’å‹•):
1.ä¹–å·§å, 2.è¶´ä¸‹, 3.é£›å», 4.å®³ç¾, 5.æ„›å¿ƒ, 6.ç”Ÿæ°£, 7.è¿½é€, 8.èººå¹³

Row 2 (å¼·çƒˆæƒ…ç·’):
9.ç™¼æŠ–, 10.å†·éœ, 11.çŸ³åŒ–å´©è£‚, 12.éˆé­‚å‡ºç«…, 13.ç–‘æƒ‘, 14.å¤§ç¬‘, 15.å¤§å“­, 16.æŒ‡

Row 3 (å‹•ä½œç‹€æ…‹):
17.ä»‹ç´¹, 18.åŠ æ²¹, 19.ç…§é¡, 20.ç¡è¦º, 21.å°æŒ‡, 22.OK, 23.NO, 24.æŠ±é ­

Row 4 (ç”Ÿæ´»æƒ…å¢ƒ):
25.æ­¡å‘¼, 26.æ„Ÿè¬, 27.å–, 28.åƒ, 29.å†è¦‹, 30.å›°æƒ‘, 31.é ­æšˆ, 32.ç„¡è¨€

Row 5 (ç‰¹æ®Šèˆ‡ç‰©ä»¶):
33.è¢«æ„›, 34.æœŸå¾…, 35.ç‚¸æ¯›, 36.è£èŒ, 37.æµå£æ°´, 38.å¿ƒç¢, 39.æŠ±é£²æ–™, 40.æ§é£Ÿç‰©`
            },
            greet: { 
                label: 'æ‰“æ‹›å‘¼', 
                texts: 'Hi, Hello, æ—©, åˆå®‰, æ™š, ä½ å¥½, åƒé£½, æ­¡è¿, æ°æ°, æœ‰ç©º, èµ°é–‹, èª°?, Yo, Hey, Bye, åœ¨å—, ç°½åˆ°, æ®æ‰‹, å—¨, å˜¿, å“ˆå›‰, æ­å€™, è«‹é€², æ…¢èµ°, ç•™æ­¥, å›ä¾†, å‡ºé–€, æ‰¾ä½ , å«æˆ‘, èˆ‰æ‰‹, æœ‰äº‹, æ²’äº‹, é»å, å ±åˆ°, è·¯é, åœè§€, åŠ ä¸Š, èªè­˜, æœ‹å‹, é€™è£¡', 
                action_list: `Row 1 (åŸºæœ¬äº’å‹•):
1.æ®æ‰‹, 2.é èº¬, 3.æ¢é ­, 4.ç¾æ¾€, 5.éåç‰‡, 6.é»é ­, 7.æ“æŠ±, 8.æ“ŠæŒ

Row 2 (ç†±æƒ…äº’å‹•):
9.è¡éä¾†, 10.æ’’èŠ±, 11.æ‹‰ç‚®, 12.è·³èˆ, 13.è½‰åœˆ, 14.å¤§å–Š, 15.é£›æ’², 16.æ¯”æ„›å¿ƒ

Row 3 (æ—¥å¸¸æ‹›å‘¼):
17.å–èŒ¶, 18.èˆ‰æ¯, 19.æ‹›æ‰‹, 20.ç¡é†’, 21.é–‹é–€, 22.é—œé–€, 23.æ¢é ­æ¢è…¦, 24.æ•¬ç¦®

Row 4 (é›¢é–‹é“åˆ¥):
25.èƒŒå½±, 26.æ®æ‰‹å¸•, 27.é¨è»Š, 28.é–‹è»Š, 29.é£›èµ°, 30.é‘½åœ°, 31.éš±èº«, 32.æµæ·šæ®æ‰‹

Row 5 (ç‰¹æ®Šæ‹›å‘¼):
33.æ‹¿å¤§è²å…¬, 34.èˆ‰ç‰ŒHi, 35.æ•²é‘¼æ‰“é¼“, 36.Wink, 37.é€ç¦®ç‰©, 38.éæƒ…æ›¸, 39.é›»è©±ä¸­, 40.è¦–è¨Šæ¡†`
            },
            work: { 
                label: 'è·å ´ç¤¾ç•œ', 
                texts: 'æ”¶åˆ°, æ”¹, é–‹æœƒ, åŠ ç­, ä¸‹ç­, ç´¯, å ±å‘Š, è¾›è‹¦, éŒ¢?, ä¸æƒ³, åŠ æ²¹, è®š, OK, No, Help, å¿™ç¢Œ, å‡ºå·®, è«‹å‡, å¯©æ ¸, é€šé, é§å›, é‡åš, æ€¥, æ‹–, ç­‰, å¥½çš„, æ˜¯, éµå‘½, äº†è§£, ç­†è¨˜, è¬è¬, éº»ç…©, æœ‰ç©º?, æ”¯æ´, ä¸‹ç·š, ä¸Šç·š, æš«é›¢, æœƒè­°, ç°¡å ±, çµæ¡ˆ', 
                action_list: `Row 1 (å·¥ä½œç‹€æ…‹):
1.æ‰“å­—, 2.æ¥é›»è©±, 3.çœ‹æ–‡ä»¶, 4.è“‹ç« , 5.æ•¬ç¦®, 6.éèŒ¶, 7.æ¬ç£š, 8.æƒåœ°

Row 2 (å´©æ½°æƒ…ç·’):
9.çœ¼ç¥æ­», 10.åé­‚, 11.ç‡ƒç‡’æ®†ç›¡, 12.ç¿»æ¡Œ, 13.æŠ“ç‹‚, 14.é ­ç—›, 15.æšˆå€’, 16.çŸ³åŒ–

Row 3 (æœƒè­°æƒ…å¢ƒ):
17.èˆ‰æ‰‹, 18.å ±å‘Š, 19.åº¦å’•, 20.æŠ„ç­†è¨˜, 21.é»é ­å¦‚æ—è’œ, 22.ç„¡å¥ˆæ”¤æ‰‹, 23.æ¯”è®š, 24.æ¯”å‰

Row 4 (ä¸‹ç­æ¸´æœ›):
25.çœ‹æ‰‹éŒ¶, 26.æ”¶åŒ…åŒ…, 27.è¡åˆºä¸‹ç­, 28.æ”¾ç…™ç«, 29.ç™±è»Ÿ, 30.æ•¸éŒ¢, 31.åƒåœŸ, 32.å–å’–å•¡

Row 5 (ç‰¹æ®Šè·å ´):
33.æŠ±å¤§è…¿, 34.èƒŒé»‘é‹, 35.ç•¶æ©Ÿ, 36.WiFiæ–·ç·š, 37.åŠ ç­åœ°ç„, 38.è–ªæ°´å°å·, 39.æ‘¸é­š, 40.å‡è·`
            },
            love: { 
                label: 'æƒ…ä¾¶æ’’å¬Œ', 
                texts: 'æ„›ä½ , æƒ³ä½ , æŠ±æŠ±, è¦ªè¦ª, å¯¶è², å…¬, å©†, å¹¹å˜›, å›å®¶, è²·, åŸè«’, å•¾, Love, Miss, Hug, å–œæ­¡, ç‰½æ‰‹, è²¼è²¼, è¹­è¹­, ä¾é , æ’’å¬Œ, ç¾, è‡‰ç´…, å¿ƒå‹•, å”¯ä½ , æ°¸é , ä¼´, å¯µæˆ‘, é¤µæˆ‘, é™ªæˆ‘, æ™šå®‰, æ—©å®‰, å¤¢ä½ , æƒœæƒœ, ç§€ç§€, å‘¼å‘¼, ä¹–ä¹–, è½è©±, é»ä½ , å”¯ä¸€çš„æ„›', 
                action_list: `Row 1 (ç”œèœœäº’å‹•):
1.æŠ±ç·Š, 2.è¹­è¹­, 3.è¦ªè‡‰, 4.ç‰½æ‰‹, 5.å°è¦–, 6.è‡‰ç´…, 7.æ¯”å¿ƒ, 8.é€èŠ±

Row 2 (æ’’å¬Œè³£èŒ):
9.æ°´æ±ªæ±ªçœ¼, 10.å˜Ÿå˜´, 11.åœ°ä¸Šæ‰“æ»¾, 12.æ‹‰è¡£è§’, 13.æ±‚æŠ±æŠ±, 14.é¤µé£Ÿ, 15.æ‘¸é ­, 16.ä¾å

Row 3 (ç”Ÿæ°£å†·æˆ°):
17.è½‰é ­ä¸ç†, 18.é¼“è‡‰é °, 19.å¤§å“­, 20.è·ªç®—ç›¤, 21.é“æ­‰, 22.èˆ‰ç™½æ——, 23.é¢å£, 24.å¿ƒç¢

Row 4 (æ—¥å¸¸ç›¸è™•):
25.ä¸€èµ·ç¡, 26.å¹é ­é«®, 27.ç…®é£¯, 28.æ´—ç¢—, 29.çœ‹é›»è¦–, 30.æ»‘æ‰‹æ©Ÿ, 31.è‡ªæ‹, 32.é€›è¡—

Row 5 (ç‰¹æ®Šæƒ…å¢ƒ):
33.å£å’š, 34.å…¬ä¸»æŠ±, 35.æ±‚å©š, 36.æ‡·å­•(æˆ–å¤§è‚š), 37.è®Šè€, 38.éˆé­‚äº’æ›, 39.å·¨å¤§æ„›å¿ƒ, 40.è‰²ç‡ç‡`
            },
            groupbuy: {
                label: 'åœ˜è³¼å°ˆç”¨',
                texts: '+1, ç™»è¨˜, çµå–®, ä¸‹å–®, åˆ°è²¨, åŒ¯æ¬¾, é¢äº¤, æ»¿å–®, å€™è£œ, å¤šå°‘?, è½‰å¸³, è¬è¬, +2, +10, $$, å·²åŒ¯, æœ«äº”, çµ±ç·¨, å«é‹, ç§, æ’, æ¶, æ²’äº†, é‚„æœ‰?, è¨±é¡˜, é–‹åœ˜, è·Ÿä¸Š, ä¸‹è»Š, å–è²¨, å¯„å‡º, ç­‰, è²·, é€›, ä¾¿å®œ, å„ªæƒ , æŠ˜æ‰£, åœ˜è³¼, +1+1, æƒ³è¦, è²·çˆ†',
                action_list: `Row 1 (ä¸‹å–®äº’å‹•):
1.èˆ‰ç‰Œ+1, 2.é›™æ‰‹+1, 3.å¡«å–®å­, 4.å¯«æ¿å¤¾, 5.æŒ‰è¨ˆç®—æ©Ÿ, 6.æ•¸éŒ¢, 7.çœ‹éŒ¢åŒ…, 8.åˆ·å¡

Row 2 (è²¨ç‰©è™•ç†):
9.æ¬ç®±å­, 10.æŠ±åŒ…è£¹, 11.æ¨æ¨è»Š, 12.æ‹†ç®±é©šå–œ, 13.æ‰“åŒ…è† å¸¶, 14.è²¼æ¨™ç±¤, 15.å †æ»¿è²¨, 16.æª¢æŸ¥

Row 3 (äº¤æ˜“ç‹€æ…‹):
17.OKæ‰‹å‹¢, 18.æ¯”éŒ¢æ‰‹å‹¢, 19.éç™¼ç¥¨, 20.è“‹ç« (å·²ä»˜), 21.æ¡æ‰‹æˆäº¤, 22.ç¦æ­¢(æ²’è²¨), 23.æµæ·š(æ²’è²·åˆ°), 24.æœŸå¾…

Row 4 (é€šçŸ¥èˆ‡ç‰©æµ):
25.é–‹è²¨è»Š, 26.é¨æ©Ÿè»Š, 27.æ‰“é›»è©±, 28.çœ‹æ¸…å–®, 29.æŒ‡æ‰‹éŒ¶(æ™‚é–“), 30.å¤§è²å…¬(åˆ°è²¨), 31.æ®æ——(é¢äº¤), 32.é èº¬

Row 5 (ç‰¹æ®Šæƒ…å¢ƒ):
33.æ¶è³¼è¡åˆº, 34.æ’éšŠ, 35.åƒåœŸ, 36.éŒ¢é£›äº†, 37.æ»¿æ»¿è³¼ç‰©è¢‹, 38.çœ¼ç›ç™¼äº®, 39.é€å‡ºæ„›å¿ƒ, 40.è·ªè¬`
            },
            guide: {
                label: 'å°éŠé ˜éšŠ',
                texts: 'é›†åˆ, å‡ºç™¼, é»å, å»æ‰€, æ‹ç…§, è‡ªç”±, å¹¾é»?, é€™è£¡, åˆ°äº†, æ³¨æ„, æ…¢æ…¢ä¾†, è·Ÿæˆ‘èµ°, Go, Stop, WC, ä¸Šè»Š, ä¸‹è»Š, éšŠæ——, æˆ¿è™Ÿ, æ—©é¤, é–€ç¥¨, è­·ç…§, è¡Œæ, åˆ¥è·‘, æ’éšŠ, å®‰éœ, è½æˆ‘, çœ‹é€™, å³é‚Š, å·¦é‚Š, å‰é¢, å¾Œé¢, æ¨“ä¸Š, æ¨“ä¸‹, é›†åˆé», å¹¾è™Ÿ, è¿·è·¯, ç­‰äºº, é»æ•¸, é–‹å¿ƒ',
                action_list: `Row 1 (å¸¶åœ˜æŒ‡ä»¤):
1.èˆ‰æ——å­, 2.å¹å“¨å­, 3.æ‹¿å¤§è²å…¬, 4.æ¯”æ–¹å‘, 5.æ‹›æ‰‹é›†åˆ, 6.æ¯”æ‰‹éŒ¶, 7.é»äººé ­, 8.çœ‹åœ°åœ–

Row 2 (äº¤é€šèˆ‡ç§»å‹•):
9.é–‹éŠè¦½è»Š, 10.ä¸Šè»Š, 11.ä¸‹è»Š, 12.è¶•è·¯è·‘æ­¥, 13.èµ°è·¯, 14.æ–‘é¦¬ç·š, 15.æŒ‡æ®äº¤é€š, 16.æ‹¿éº¥å…‹é¢¨

Row 3 (æ™¯é»äº’å‹•):
17.æ‹ç…§å§¿å‹¢, 18.æ‹¿ç›¸æ©Ÿ, 19.è‡ªæ‹æ£’, 20.æ¯”YA, 21.çœ‹é æ–¹, 22.æˆ´å¢¨é¡, 23.é®é™½, 24.å–æ°´

Row 4 (æœå‹™èˆ‡æé†’):
25.ç™¼é–€ç¥¨, 26.ç™¼ä¾¿ç•¶, 27.æŒ‡å»æ‰€, 28.æ¯”å™“(å®‰éœ), 29.æ³¨æ„ç¬¦è™Ÿ, 30.ç¦æ­¢ç¬¦è™Ÿ, 31.OKç‰Œ, 32.å•è™Ÿç‰Œ

Row 5 (ç‰¹æ®Šæƒ…å¢ƒ):
33.å¤§æ±—æ·‹æ¼“, 34.ç´¯ç™±, 35.å…ƒæ°£æ»¿æ»¿, 36.é èº¬é“è¬, 37.æ•¸éŒ¢(å°è²»), 38.æ‹¿è­·ç…§, 39.æ¨è¡Œæ, 40.ç¡è¦º`
            },
            secretary: {
                label: 'ç§˜æ›¸è¡Œæ”¿',
                texts: 'è€é—†æ‰¾, ç°½å, é–‹æœƒ, è¡Œç¨‹, å ±å¸³, è«‹æ¬¾, æé†’, å½±å°, é ç´„, å¯„å‡º, ç¢ºèª, æ€¥ä»¶, ASAP, Sign, Copy, è“‹ç« , ç”¨å°, æ­¸æª”, æƒæ, å‚³çœŸ, è¨‚é¤, è¨‚æˆ¿, æ©Ÿç¥¨, åŒ…è£¹, å¿«é, è¨ªå®¢, èŒ¶æ°´, è¨˜éŒ„, è¯çµ¡, è½‰æ¥, ç•™è¨€, ç¨ç­‰, æŸ¥è©¢, è³‡æ–™, å ±å‘Š, é ç®—, æ ¸éŠ·, æ¡è³¼, æ–‡å…·, è¬è¬',
                action_list: `Row 1 (æ–‡æ›¸è™•ç†):
1.æ‰“é›»è…¦, 2.è“‹ç« , 3.æŠ±æ–‡ä»¶å±±, 4.å¯«å­—, 5.éç­†, 6.æ•´ç†è³‡æ–™, 7.é‡˜æ›¸æ©Ÿ, 8.ç¢ç´™æ©Ÿ

Row 2 (æºé€šè¯ç¹«):
9.æ¥é›»è©±, 10.æ›é›»è©±, 11.æ‰‹æ©Ÿæ‰“å­—, 12.å»£æ’­, 13.éåç‰‡, 14.æ”¶ä¿¡, 15.å¯„ä¿¡, 16.æ¯”è«‹é€²

Row 3 (æœƒè­°è¡Œç¨‹):
17.æŒ‡æ—¥æ›†, 18.çœ‹æ‰‹éŒ¶, 19.åšç°¡å ±, 20.æŒ‡ç™½æ¿, 21.å¯«ç­†è¨˜, 22.èˆ‰æ‰‹ç™¼å•, 23.é»é ­, 24.æ–é ­

Row 4 (æƒ…ç·’ç‹€æ…‹):
25.æ¨çœ¼é¡(å°ˆæ¥­), 26.çœ¼ç¥æ­»(åŠ ç­), 27.æ…Œå¼µ(æ€¥ä»¶), 28.ç”Ÿæ°£(é€€ä»¶), 29.å–èŒ¶æ”¾é¬†, 30.æ¯”OK, 31.æ¯”è®š, 32.é èº¬

Row 5 (è¾¦å…¬é›œå‹™):
33.å€’å’–å•¡, 34.è¨‚ä¾¿ç•¶, 35.ç®—éŒ¢, 36.ç™¼è–ªæ°´, 37.é›»è…¦ç•¶æ©Ÿ, 38.WiFiç¬¦è™Ÿ, 39.ä¾¿åˆ©è²¼, 40.æº–æ™‚ä¸‹ç­`
            }
        };

        const PROMPT_STYLES = [
            { id: 'qversion', label: 'é€šç”¨ Q ç‰ˆ', desc: 'å¯æ„›ã€æ´»æ½‘ã€2Då¹³é¢' },
            { id: 'watercolor', label: 'æ°´å½©æ‰‹ç¹ª', desc: 'æŸ”å’Œæ°´å½©æšˆæŸ“è³ªæ„Ÿï¼Œé‚Šç·£ç•¥å¸¶æ‰‹ç¹ªç²—ç³™æ„Ÿï¼Œæ–‡é’é¢¨æ ¼ã€‚' },
            { id: 'crayon', label: 'è Ÿç­†ç«¥è¶£', desc: 'è Ÿç­†ç­†è§¸ï¼Œé¡†ç²’æ„Ÿï¼Œå…’ç«¥ç•«é¢¨æ ¼ï¼Œè‰²å½©é®®è±”é£½å’Œã€‚' },
            { id: 'lineart', label: 'æ¥µç°¡ç·šæ¢', desc: 'é»‘ç™½æˆ–å–®è‰²ç·šæ¢ç‚ºä¸»ï¼Œæ¥µç°¡é¢¨æ ¼ï¼Œæ²’æœ‰éå¤šå¡«è‰²ã€‚' },
            { id: 'pixel', label: 'åƒç´ é¢¨', desc: 'å¾©å¤éŠæˆ²ã€8-bitã€é»é™£åœ–é¢¨æ ¼ã€‚' },
            { id: 'anime', label: 'æ—¥ç³»å‹•æ¼«', desc: 'ç²¾ç·»è³½ç’ç’ä¸Šè‰²ï¼Œå¤§çœ¼ï¼Œæ—¥ç³»å‹•æ¼«é¢¨æ ¼ã€‚' }
        ];

        const PROMPT_COLORS = [
            { id: 'vivid', label: 'é®®è±”äº®éº— (LINEæ¨™æº–)', desc: 'é«˜é£½å’Œåº¦ï¼Œè‰²å½©é®®æ˜ï¼Œå°æ¯”åº¦é«˜ï¼Œå…¸å‹ LINE è²¼åœ–é…è‰²ã€‚' },
            { id: 'soft', label: 'æŸ”å’Œæº«æš– (è«è˜­è¿ª)', desc: 'ä½é£½å’Œåº¦ï¼Œè«è˜­è¿ªè‰²ç³»ï¼Œå¤§åœ°è‰²ã€ç²‰è†šè‰²ï¼Œæº«æš–ç™‚ç™’ï¼Œä¸åˆºçœ¼ã€‚' },
            { id: 'cool', label: 'æ¸…çˆ½å†·è‰²', desc: 'ä»¥è—ã€é’ã€ç´«ã€ç™½ç‚ºä¸»ï¼Œæ¸…æ¶¼æ„Ÿï¼Œç§‘æŠ€æ„Ÿæˆ–å¯§éœæ„Ÿã€‚' },
            { id: 'retro', label: 'å¾©å¤æ˜­å’Œ', desc: 'æ³›é»ƒæ‡·èˆŠæ„Ÿï¼Œæ©˜é»ƒè‰²èª¿ï¼Œä½å°æ¯”ï¼ŒåƒèˆŠæµ·å ±æˆ–åº•ç‰‡ç›¸æ©Ÿé¢¨æ ¼ã€‚' },
            { id: 'pastel', label: 'å¤¢å¹»ç²‰å«©', desc: 'é¦¬å¡é¾è‰²ç³»ï¼Œç²‰ç´…ã€ç²‰è—ã€ç²‰ç´«ï¼Œå¤¢å¹»å°‘å¥³é¢¨æ ¼ã€‚' }
        ];

        const CHAR_TYPES = [
            { id: 'upload', label: 'åƒè€ƒä¸Šå‚³åœ–ç‰‡ (Reference Upload)', desc: 'è«‹åš´æ ¼åƒè€ƒä¸Šå‚³åœ–ç‰‡ä¸­çš„è§’è‰²ç‰¹å¾µï¼ˆé«®å‹ã€æœè£ã€äº”å®˜ã€é…è‰²ï¼‰ï¼Œä¿æŒå®Œå…¨ä¸€è‡´ã€‚' },
            { id: 'custom', label: 'è‡ªè¨‚è§’è‰² (Custom)', desc: '' }
        ];

        const PROMPT_MODES = [
            { id: 'char_only', label: 'ç´”ä¸»è§’ (Character Only)', icon: <IconStar className="w-4 h-4"/> },
            { id: 'char_text', label: 'ä¸»è§’ + æ–‡å­— (Char + Text)', icon: <IconMessageCircle className="w-4 h-4"/> },
            { id: 'text_only', label: 'ç´”å¤§å­— (Text Only)', icon: <IconEdit className="w-4 h-4"/> }
        ];

        const App = () => {
            const [originalSheet, setOriginalSheet] = useState(null);
            const [slicedPieces, setSlicedPieces] = useState([]); 
            const [finalImages, setFinalImages] = useState([]); 
            const [tabId, setTabId] = useState(null);
            const [startNumber, setStartNumber] = useState(1); 
            const [step, setStep] = useState(1); 
            const [isProcessing, setIsProcessing] = useState(false);
            const [processedCount, setProcessedCount] = useState(0);
            
            // Alignment (Percentage Based)
            const [gridAdj, setGridAdj] = useState({ xPercent: 0, yPercent: 0, scale: 1.0 });
            
            // Prompt State
            const [promptMode, setPromptMode] = useState('char_only');
            const [charType, setCharType] = useState('upload');
            const [customCharDesc, setCustomCharDesc] = useState('');
            const [activeTheme, setActiveTheme] = useState('daily');
            const [activeStyle, setActiveStyle] = useState('qversion');
            const [activeColor, setActiveColor] = useState('vivid');
            
            // Settings Panel
            const [showSettings, setShowSettings] = useState(false); 
            const [showAdvanced, setShowAdvanced] = useState(true);
            const [showPromptGuide, setShowPromptGuide] = useState(true); 
            const [copySuccess, setCopySuccess] = useState(false);
            const [autoRemoveBg, setAutoRemoveBg] = useState(true);
            const [targetColorHex, setTargetColorHex] = useState("#00ff00");
            const [colorTolerance, setColorTolerance] = useState(35); 
            const [smoothness, setSmoothness] = useState(2); 
            const [despill, setDespill] = useState(true); 
            const [zoomLevel, setZoomLevel] = useState(1.00); 
            const workerRef = useRef(null);

            // GRID CONFIG (Fixed 8x5)
            const gridConfig = { cols: 8, rows: 5, label: '8x5 (40å¼µ)', desc: 'æ©«å‘å¤§åœ–æ¨¡å¼', w: 2624, h: 1632 };

            useEffect(() => {
                workerRef.current = new Worker(workerUrl);
                workerRef.current.onmessage = (e) => {
                    const { id, dataUrl } = e.data;
                    setFinalImages(prev => {
                        const exists = prev.find(img => img.id === id);
                        if (exists) return prev;
                        return [...prev, { id, dataUrl, rawSource: null }].sort((a,b) => a.id - b.id);
                    });
                    setProcessedCount(prev => prev + 1);
                };
                return () => { workerRef.current.terminate(); }
            }, []);

            useEffect(() => {
                if (processedCount === TOTAL_ITEMS && isProcessing) {
                    setIsProcessing(false);
                    setTabId(1); // Default select first one as tab if processed
                    setStep(3);
                }
            }, [processedCount, isProcessing]);

            useEffect(() => {
                applyPreset('green');
            }, []);

            const handleUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const img = new Image();
                    img.onload = () => {
                        setOriginalSheet(img);
                        setGridAdj({ xPercent: 0, yPercent: 0, scale: 1.0 });
                        setSlicedPieces([]);
                        setFinalImages([]);
                        setStep(1);
                    };
                    img.src = ev.target.result;
                };
                reader.readAsDataURL(file);
            };

            const getDynamicPrompt = () => {
                const selectedChar = CHAR_TYPES.find(c => c.id === charType);
                const charDesc = charType === 'custom' ? customCharDesc : selectedChar.desc;
                const charName = charType === 'custom' ? 'è‡ªè¨‚è§’è‰²' : selectedChar.label;
                const theme = PROMPT_THEMES[activeTheme];
                const style = PROMPT_STYLES.find(s => s.id === activeStyle) || PROMPT_STYLES[0];
                const color = PROMPT_COLORS.find(c => c.id === activeColor) || PROMPT_COLORS[0];

                let contentSection = "";
                let constraintSection = "";

                // é€šç”¨çš„æ–‡å­—é¢¨æ ¼å®šç¾© (å¼·åˆ¶å¥—ç”¨æ–¼æ‰€æœ‰å«å­—æ¨¡å¼)
                const textStylePrompt = `
    * **æ–‡å­—è¨­è¨ˆè¦ç¯„ (æœ€é«˜å„ªå…ˆç´š)ï¼š**
        1. **å°ºå¯¸æ¥µå¤§ (Giant Text)**ï¼šæ–‡å­—å¿…é ˆéå¸¸å·¨å¤§ï¼Œ**é¢ç©éœ€èˆ‡è§’è‰²é ­éƒ¨å¤§å°ç›¸ç•¶ (ç´„ä½”å–®æ ¼ 50%)**ï¼Œç¢ºä¿åœ¨æ‰‹æ©Ÿå°è¢å¹•ä¸Šæ¸…æ™°å¯è®€ã€‚
        2. **è‰²å½©è±å¯Œ (Vibrant & Colorful)**ï¼š**çµ•å°ç¦æ­¢**ä½¿ç”¨å–®èª¿çš„ç´”é»‘æˆ–ç´”ç™½å­—ã€‚è«‹ä½¿ç”¨ **é«˜é£½å’Œåº¦çš„ç³–æœè‰²** (å¦‚äº®ç²‰ã€é®®æ©˜ã€å¤©è—ã€ç´«è‰²)ï¼Œ**åš´ç¦ä½¿ç”¨ä»»ä½•ç¶ è‰² (No Green)** (ä»¥å…è¢«å»èƒŒèª¤åˆª)ï¼Œä¸¦ç‚ºæ¯å€‹å­—åŠ ä¸Š **ç²—ç™½è‰²å¤–æ¡† (Thick White Outline)** æˆ– **æ·±è‰²æé‚Š**ï¼Œæ‰“é€ åƒè²¼ç´™èˆ¬çš„ç«‹é«”æ„Ÿã€‚
        3. **å­—é«”é¢¨æ ¼ (Cute & Pop)**ï¼šä½¿ç”¨ **åœ“æ½¤å¯æ„›çš„æ‰‹å¯«é«” (Rounded Hand-drawn)** æˆ– **æ³¢æ™®è—è¡“å­—é«” (Pop Art)**ã€‚å­—é«”è¦è‚¥åšã€é£½æ»¿ï¼Œä¸è¦ä½¿ç”¨ç´°ç·šæ¢å­—é«”ã€‚
        4. **æ§‹åœ–äº’å‹•**ï¼šæ–‡å­—ä¸èƒ½åªæ˜¯æ¼‚æµ®åœ¨æ—é‚Šï¼Œå¿…é ˆèˆ‡è§’è‰²äº’å‹• (ä¾‹å¦‚ï¼šè§’è‰²æŠ±è‘—å­—ã€å­—åƒå¸½å­ä¸€æ¨£æˆ´åœ¨é ­ä¸Šã€å­—å¾å˜´å·´å–Šå‡ºä¾†)ã€‚`;

                if (promptMode === 'char_only') {
                    contentSection = `## ã€40 æ ¼è¡¨æƒ…èˆ‡å‹•ä½œæ¸…å–®ã€‘\nï¼ˆè«‹ä¾ç…§ 8x5 çš„é †åºæ’åˆ—ï¼Œç¢ºä¿æ¯æ ¼å‹•ä½œä¸åŒï¼‰\n\n${theme.action_list}`;
                    constraintSection = `* æ¯ä¸€æ ¼åƒ…åŒ…å«ï¼šå–®ä¸€è§’è‰²æœ¬é«”ï¼ˆå¯æ­é…å°‘é‡å¿…è¦çš„ç°¡å–®æƒ…ç·’ç¬¦è™Ÿï¼Œå¦‚æ„›å¿ƒã€æ±—æ»´ã€ç”Ÿæ°£ç¬¦è™Ÿï¼Œç¬¦è™Ÿä¸å¯å–§è³“å¥ªä¸»æˆ–é®æ“‹è‡‰éƒ¨ï¼‰ã€‚\n* âŒ ä¸åŒ…å«ä»»ä½•å ´æ™¯èƒŒæ™¯ã€‚\n* âŒ ä¸åŒ…å«ä»»ä½•æ–‡å­—å…§å®¹ã€‚\n* âŒ ä¸åŒ…å«ä»»ä½•æ‰‹æ©Ÿç³»çµ± emojiã€‚`;
                } else if (promptMode === 'char_text') {
                    contentSection = `## ã€40 æ ¼å…§å®¹çµ„åˆã€‘\nè«‹å°‡ä»¥ä¸‹å‹•ä½œèˆ‡æ–‡å­—çµåˆï¼Œ**æ–‡å­—æ˜¯éå¼·åˆ¶çš„ (Optional)**ï¼Œè«‹éš¨æ©Ÿåˆ†é…ï¼šç´„ 60% çš„æ ¼å­åŒ…å«æ–‡å­—ï¼Œ40% çš„æ ¼å­ç¶­æŒç´”è¡¨æƒ…ã€‚\n\n**å‹•ä½œåƒè€ƒï¼š**\n${theme.action_list}\n\n**å¯æ­é…çš„æ–‡å­— (éš¨æ©Ÿé¸ç”¨)ï¼š**\n${theme.texts}`;
                    constraintSection = `* æ··åˆæ¨¡å¼ï¼šéƒ¨åˆ†æ ¼å­ç‚ºã€Œè§’è‰²+æ–‡å­—ã€ï¼Œéƒ¨åˆ†æ ¼å­ç‚ºã€Œç´”è§’è‰²ã€ã€‚\n${textStylePrompt}\n* æ–‡å­—é™åˆ¶ï¼šç¹é«”ä¸­æ–‡ç‚ºä¸»ï¼Œå¯æ··æ­ç°¡å–®è‹±æ–‡ (OK, Bye, Yes, No)ï¼Œæ‰‹å¯«é¢¨æ ¼ï¼Œ**åš´æ ¼æ§åˆ¶åœ¨ 2 å­—ä»¥å…§**ã€‚\n* âŒ ä¸åŒ…å«è¤‡é›œèƒŒæ™¯ã€‚`;
                } else if (promptMode === 'text_only') {
                    contentSection = `## ã€40 æ ¼ç´”æ–‡å­—+è£é£¾æ¸…å–®ã€‘\nè«‹è¨­è¨ˆå¤šå½©ã€æ´»æ½‘çš„è—è¡“å­—é«”ï¼Œä¸¦æ­é…ç›¸é—œçš„å°è£é£¾åœ–æ¡ˆã€‚\n\n${theme.texts}`;
                    constraintSection = `* æ–‡å­—å…§å®¹ï¼šè«‹ä¾ç…§ä¸‹æ–¹æ–‡å­—æ¸…å–®ï¼Œ**ç¢ºä¿ 40 æ ¼å…§å®¹ä¸é‡è¤‡**ã€‚\n* æ¯ä¸€æ ¼åŒ…å«ï¼šè¨­è¨ˆæ„Ÿå¼·çƒˆçš„æ–‡å­— + è£é£¾æ€§å°åœ–ç¤º (Decor Icons)ã€‚\n${textStylePrompt}\n* è£é£¾å…ƒç´ ï¼šå¯åŒ…å«ç°¡å–®çš„æ‰‹å‹¢ (å¦‚OKæ‰‹ã€æ¯”è®š)ã€è¡¨æƒ…ç¬¦è™Ÿ (æ˜Ÿæ˜Ÿã€æ„›å¿ƒã€é©šå˜†è™Ÿã€èŠ±æœµ) æˆ–èˆ‡æ–‡å­—ç›¸é—œçš„å¾®å‹æ’åœ–ã€‚\n* âŒ ä¸åŒ…å«å®Œæ•´è§’è‰²æ’åœ–ï¼Œåƒ…é™å±€éƒ¨æ‰‹å‹¢æˆ–å°åœ–æ¨™ã€‚`;
                }

                return `# LINE è¡¨æƒ…è²¼ 40 æ ¼å®Œæ•´ç‰ˆ Prompt (å°ºå¯¸ä¿®æ­£ç‰ˆï¼š2624x1632)

è«‹ç”Ÿæˆä¸€å¼µåŒ…å« 40 å€‹ä¸åŒå‹•ä½œèˆ‡è¡¨æƒ…çš„ã€${charName}ã€‘è²¼åœ–é›†å¤§åœ–ï¼Œç”¨æ–¼ LINE è¡¨æƒ…è²¼è£½ä½œã€‚

## ã€æœ€é«˜å„ªå…ˆç´šç´„æŸï¼šä½ˆå±€ã€é‚Šè·èˆ‡å±…ä¸­ã€‘
**ï¼ˆæ­¤éƒ¨åˆ†è«‹åš´æ ¼åŸ·è¡Œï¼Œç¢ºä¿å¾ŒçºŒè£åˆ‡ä¸å‡ºéŒ¯ï¼‰**

1.  **å¤§åœ–è¦æ ¼**ï¼šæ•´å¼µåœ–ç‰‡ç•«å¸ƒå°ºå¯¸ç‚º **2624 pixels (å¯¬) x 1632 pixels (é«˜)**ã€‚
2.  **éš±å½¢ç¶²æ ¼çµæ§‹**ï¼šç•«é¢å…§éƒ¨é‚è¼¯åˆ†ç‚º 8 ç›´æ¬„ x 5 æ©«åˆ—ï¼Œå…± 40 å€‹å–®å…ƒæ ¼ã€‚
    * è¨ˆç®—åŸºæº–ï¼šæ¯ä¸€æ ¼çš„å°ºå¯¸ç´„ç‚º **328 x 326 pixels**ã€‚
3.  **ç´”æ·¨èƒŒæ™¯**ï¼šæ•´å¼µå¤§åœ–èƒŒæ™¯çµ±ä¸€ç‚ºç´”ç¶ è‰² (#00FF00)ï¼Œç„¡æ¼¸å±¤ã€ç„¡é›œé»ã€‚**ä¸å¯ç¹ªè£½ä»»ä½•é»‘è‰²çš„ç¶²æ ¼åˆ†éš”ç·šæˆ–é‚Šæ¡†**ã€‚
4.  **å¼·åˆ¶å®Œç¾å±…ä¸­**ï¼šåœ¨æ¯ä¸€å€‹éš±å½¢å–®å…ƒæ ¼å…§ï¼Œä¸»é«”å¿…é ˆåœ¨è¦–è¦ºä¸Šã€Œå®Œç¾å±…ä¸­ã€æ’åˆ—ã€‚
5.  **åš´æ ¼å®‰å…¨é‚Šè· (Strict Safety Margin)**ï¼š
    * **é‡è¦ï¼š** æ¯å€‹è²¼åœ–ä¹‹é–“ï¼ˆå–®å…ƒæ ¼é‚Šç•Œï¼‰å¿…é ˆä¿ç•™ **30 pixels** çš„ç´”ç¶ è‰²é–“éš”ã€‚
    * **çµ•å°ç¦æ­¢**ä»»ä½•åƒç´ é»è²¼é½Šã€æ¥è§¸æˆ–è¶…å‡ºå–®å…ƒæ ¼ç¯„åœã€‚ç¢ºä¿æ¯å€‹è§’è‰²å‘¨åœéƒ½æœ‰ä¸€åœˆæ˜é¡¯çš„ç¶ è‰²ã€Œå®‰å…¨æ°£å›Šã€ã€‚

## ã€è§’è‰²èˆ‡é¢¨æ ¼ä¸€è‡´æ€§ã€‘
* **è§’è‰²è¨­å®š**ï¼š${charDesc} (**æ³¨æ„ï¼šè‹¥åƒè€ƒåœ–ç‰‡ä¸­æ–‡å­—è¼ƒå°æˆ–é¡è‰²å–®èª¿ï¼Œè«‹å¿½ç•¥è©²æ–‡å­—é¢¨æ ¼ï¼Œå¼·åˆ¶æ¡ç”¨ä¸‹æ–¹çš„ã€Œæ–‡å­—è¨­è¨ˆè¦ç¯„ã€é€²è¡Œå‰µä½œã€‚**)
* **ç•«é¢¨è¨­å®š**ï¼š${style.desc}
* **é…è‰²é¢¨æ ¼**ï¼š${color.desc}
* **ç·šæ¢èˆ‡ä¸Šè‰²**ï¼šç·šæ¢å–®ä¸€ç²—ç´°ï¼Œåœ“è§’ç­†è§¸ï¼Œä¹¾æ·¨å¹³æ»‘ã€‚ä¸Šè‰²å¹³å¡—ç‚ºä¸»ï¼Œåƒ…ä¸€å±¤è¼•å¾®é™°å½±ã€‚
* **é¡è‰²ç¦å¿Œ**ï¼šè§’è‰²æœ¬é«”ã€æœè£èˆ‡æ–‡å­—**çµ•å°ä¸å¯ä½¿ç”¨ç¶ è‰² (#00FF00 æˆ–ç›¸è¿‘è‰²)**ï¼Œå› ç‚ºç¶ è‰²æ˜¯ç”¨ä½œå»èƒŒçš„èƒŒæ™¯è‰²ï¼Œé¿å…è¢«èª¤åˆªã€‚

## ã€ç•«é¢å…§å®¹è¦ç¯„ã€‘
${constraintSection}

${contentSection}

## ã€æœ€çµ‚è¼¸å‡ºç¢ºèªã€‘
è¼¸å‡ºä¸€å¼µ 2624x1632 çš„ç´”ç¶ åº•åœ–ç‰‡ï¼Œä¸Šé¢æ•´é½Šæ’åˆ— 40 å€‹å–®å…ƒï¼Œç„¡ç¶²æ ¼ç·šï¼Œæ¯å€‹å–®å…ƒéƒ½å®Œç¾å±…ä¸­ä¸”å‘¨åœæœ‰å……è¶³çš„é‚Šè·ï¼ˆè‡³å°‘ 30px é–“éš”ï¼‰ã€‚`;
            };

            const handleCopyPrompt = () => {
                const text = getDynamicPrompt();
                const textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    setCopySuccess(true);
                    setTimeout(() => setCopySuccess(false), 2000);
                } catch (err) {
                    console.error('è¤‡è£½å¤±æ•—', err);
                }
                document.body.removeChild(textArea);
            };

            const PromptDisplay = () => {
                const theme = PROMPT_THEMES[activeTheme];
                const style = PROMPT_STYLES.find(s => s.id === activeStyle) || PROMPT_STYLES[0];
                const color = PROMPT_COLORS.find(c => c.id === activeColor) || PROMPT_COLORS[0];
                const selectedChar = CHAR_TYPES.find(c => c.id === charType);
                const charDescText = charType === 'custom' ? (customCharDesc || "ï¼ˆè«‹è¼¸å…¥æè¿°ï¼‰") : selectedChar?.desc;
                const charNameText = charType === 'custom' ? 'è‡ªè¨‚è§’è‰²' : selectedChar?.label;

                return (
                    <div className="prompt-content text-sm font-mono bg-slate-800 p-4 rounded-lg border border-slate-700 h-[450px] overflow-y-auto scrollbar-thin">
                        <div className="font-bold text-xl mb-2 text-white">âœ… 8x5 (40å¼µ) è¡¨æƒ…è²¼ Prompt æŒ‡å¼•</div>
                        
                        <p className="mb-4">è«‹ç”Ÿæˆä¸€å¼µåŒ…å« <span className="fixed-val">40 å€‹</span> ä¸åŒå‹•ä½œèˆ‡è¡¨æƒ…çš„ <span className="var-highlight">ã€{charNameText}ã€‘</span> è²¼åœ–é›†å¤§åœ–ã€‚</p>

                        <span className="section-title">ã€æœ€é«˜å„ªå…ˆç´šç´„æŸã€‘</span>
                        <ul className="list-disc pl-5 mb-4 text-slate-300">
                            <li>å¤§åœ–è¦æ ¼ï¼š<span className="fixed-val">2624 x 1632 px</span>ã€‚</li>
                            <li>ç¶²æ ¼çµæ§‹ï¼š<span className="fixed-val">8 æ¬„ x 5 åˆ—</span>ã€‚</li>
                            <li>èƒŒæ™¯ï¼š<span className="fixed-val">#00FF00 (ç´”ç¶ è‰²)</span>ã€‚</li>
                            <li><span className="text-red-400 font-bold">å¼·åˆ¶å±…ä¸­ï¼š</span> è²¼åœ–ä¹‹é–“ä¿ç•™ <span className="fixed-val">30px</span> é–“éš”ã€‚</li>
                        </ul>

                        <span className="section-title">ã€é¢¨æ ¼èˆ‡é…è‰²ã€‘</span>
                        <ul className="list-disc pl-5 mb-4 text-slate-300">
                            <li>è§’è‰²è¨­å®šï¼š<span className="var-highlight">{charDescText}</span></li>
                            <li>ç•«é¢¨è¨­å®šï¼š<span className="var-highlight">{style?.desc}</span></li>
                            <li>é…è‰²é¢¨æ ¼ï¼š<span className="var-highlight">{color?.desc}</span></li>
                        </ul>

                        <span className="section-title">ã€ç•«é¢å…§å®¹è¦ç¯„ã€‘</span>
                        {promptMode === 'char_only' && (
                            <ul className="list-disc pl-5 mb-4 text-slate-300">
                                <li>æ¯ä¸€æ ¼åƒ…åŒ…å«ï¼š<span className="var-highlight">å–®ä¸€è§’è‰²æœ¬é«”</span>ã€‚</li>
                                <li>âŒ ä¸åŒ…å«ä»»ä½•æ–‡å­—å…§å®¹ã€‚</li>
                            </ul>
                        )}
                        {promptMode === 'char_text' && (
                            <ul className="list-disc pl-5 mb-4 text-slate-300">
                                <li>æ··åˆæ¨¡å¼ï¼š<span className="var-highlight">60% è§’è‰²+æ–‡å­—ï¼Œ40% ç´”è§’è‰²</span> (éš¨æ©Ÿåˆ†é…)ã€‚</li>
                                <li><strong>æ–‡å­—è¨­è¨ˆ (é—œéµ)ï¼š</strong> <span className="var-highlight">å·¨å¤§æ–‡å­— (40%ç‰ˆé¢)</span>ã€<span className="var-highlight">å¤šå½©é…è‰²</span>ã€<span className="var-highlight">å¯æ„›åœ“é«”</span>ã€‚</li>
                                <li>æ–‡å­—é™åˆ¶ï¼š<span className="text-yellow-300">2 å­—ä»¥å…§</span> (ä¸­è‹±æ–‡æ··æ­)ã€‚</li>
                            </ul>
                        )}
                        {promptMode === 'text_only' && (
                            <ul className="list-disc pl-5 mb-4 text-slate-300">
                                <li>æ¯ä¸€æ ¼åŒ…å«ï¼š<span className="var-highlight">è¨­è¨ˆæ„Ÿå¼·çƒˆçš„è—è¡“æ–‡å­— + è£é£¾å°åœ–ç¤º</span>ã€‚</li>
                                <li>æ–‡å­—é¢¨æ ¼ï¼š<span className="text-yellow-300">å¤šå½©æ´»æ½‘ï¼Œéåˆ¶å¼æ’ç‰ˆ</span>ã€‚</li>
                                <li>è£é£¾å…ƒç´ ï¼š<span className="text-yellow-300">å°æ‰‹å‹¢ã€ç¬¦è™Ÿ (OKæ‰‹ã€æ˜Ÿæ˜Ÿã€æ„›å¿ƒ)</span>ã€‚</li>
                                <li>âŒ ä¸åŒ…å«å®Œæ•´è§’è‰²æ’åœ–ã€‚</li>
                            </ul>
                        )}

                        <span className="section-title">ã€å…§å®¹æ¸…å–®ã€‘</span>
                        {promptMode !== 'text_only' && (
                            <div className="mb-4">
                                <div className="text-xs text-slate-400 mb-1">å‹•ä½œåƒè€ƒï¼š</div>
                                <div className="bg-slate-900 p-2 rounded border border-slate-600 text-xs leading-relaxed text-slate-300 whitespace-pre-wrap">
                                    {theme.action_list}
                                </div>
                            </div>
                        )}
                        
                        {promptMode !== 'char_only' && (
                            <div>
                                <div className="text-xs text-slate-400 mb-1">æ–‡å­—åƒè€ƒ (ä¾åºå¡«å…¥)ï¼š</div>
                                <div className="bg-slate-900 p-2 rounded border border-slate-600 text-xs leading-relaxed text-yellow-300 break-all">
                                    {theme.texts}
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            const performSlice = () => {
                if (!originalSheet) return;
                setIsProcessing(true);
                setTimeout(() => {
                    const pieces = [];
                    const canvas = document.createElement('canvas');
                    canvas.width = originalSheet.width;
                    canvas.height = originalSheet.height;
                    const ctx = canvas.getContext('2d', { willReadFrequently: true });
                    ctx.fillStyle = targetColorHex;
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    const w = originalSheet.width * gridAdj.scale;
                    const h = originalSheet.height * gridAdj.scale;
                    const xOffset = canvas.width * (gridAdj.xPercent / 100);
                    const yOffset = canvas.height * (gridAdj.yPercent / 100);
                    const x = (canvas.width - w) / 2 + xOffset;
                    const y = (canvas.height - h) / 2 + yOffset;
                    ctx.drawImage(originalSheet, x, y, w, h);
                    const pieceW = canvas.width / COLS;
                    const pieceH = canvas.height / ROWS;
                    for(let r=0; r<ROWS; r++) {
                        for(let c=0; c<COLS; c++) {
                            const pCanvas = document.createElement('canvas');
                            pCanvas.width = pieceW;
                            pCanvas.height = pieceH;
                            const pCtx = pCanvas.getContext('2d');
                            pCtx.drawImage(canvas, c*pieceW, r*pieceH, pieceW, pieceH, 0, 0, pieceW, pieceH);
                            pieces.push({
                                id: r*COLS+c+1,
                                rawCanvas: pCanvas,
                                previewUrl: pCanvas.toDataURL('image/png')
                            });
                        }
                    }
                    setSlicedPieces(pieces);
                    setStep(2);
                    setIsProcessing(false);
                }, 50);
            };

            const performProcessing = async () => {
                if (!autoRemoveBg) {
                    setFinalImages(slicedPieces.map(piece => ({ id: piece.id, dataUrl: piece.previewUrl })));
                    // Removed setMainId(1);
                    setTabId(1);
                    setStep(3);
                    return;
                }
                setIsProcessing(true);
                setProcessedCount(0);
                setFinalImages([]);
                const targetSize = 360; 
                slicedPieces.forEach(piece => {
                    const workCanvas = document.createElement('canvas');
                    workCanvas.width = targetSize;
                    workCanvas.height = targetSize;
                    const workCtx = workCanvas.getContext('2d');
                    workCtx.clearRect(0, 0, targetSize, targetSize);
                    const rawW = piece.rawCanvas.width;
                    const rawH = piece.rawCanvas.height;
                    const scale = Math.max(targetSize/rawW, targetSize/rawH) * zoomLevel;
                    const drawW = rawW * scale;
                    const drawH = rawH * scale;
                    const dx = (targetSize - drawW) / 2;
                    const dy = (targetSize - drawH) / 2;
                    workCtx.drawImage(piece.rawCanvas, 0, 0, rawW, rawH, dx, dy, drawW, drawH);
                    createImageBitmap(workCanvas).then(bitmap => {
                        workerRef.current.postMessage({
                            imageBitmap: bitmap,
                            id: piece.id,
                            targetColor: targetColorHex,
                            tolerance: colorTolerance,
                            smoothness: smoothness,
                            despill: despill
                        }, [bitmap]);
                    });
                });
            };

            const resizeImageFromUrl = (dataUrl, width, height) => {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        const scale = Math.min(width/img.width, height/img.height);
                        const newW = img.width * scale;
                        const newH = img.height * scale;
                        ctx.drawImage(img, 0, 0, img.width, img.height, (width-newW)/2, (height-newH)/2, newW, newH);
                        resolve(canvas.toDataURL('image/png').split(',')[1]);
                    };
                    img.src = dataUrl;
                });
            };

            const getFileName = (index) => (startNumber + index).toString().padStart(3, '0');

            const downloadZip = async () => {
                const zip = new JSZip();
                await Promise.all(finalImages.map(async (img, idx) => {
                    const b64 = await resizeImageFromUrl(img.dataUrl, 180, 180); 
                    zip.file(`${getFileName(idx)}.png`, b64, {base64:true});
                }));
                // Removed Main Image zip generation
                if (tabId) {
                    const tabImg = finalImages.find(img => img.id === tabId);
                    if (tabImg) zip.file("tab.png", await resizeImageFromUrl(tabImg.dataUrl, 96, 74), {base64: true});
                }
                zip.generateAsync({type:"blob"}).then(c => saveAs(c, "line_emojis_8x5_pack.zip"));
            };

            const applyPreset = (type) => {
                if (type === 'green') {
                    setTargetColorHex("#00FF00");
                    setColorTolerance(35); 
                    setSmoothness(2);
                    setDespill(true);
                    setZoomLevel(1.02); 
                } else if (type === 'black') {
                    setTargetColorHex("#000000");
                    setColorTolerance(15);
                    setSmoothness(1);
                    setDespill(false);
                    setZoomLevel(1.02);
                } else if (type === 'white') {
                    setTargetColorHex("#FFFFFF");
                    setColorTolerance(15);
                    setSmoothness(1);
                    setDespill(false);
                    setZoomLevel(1.02);
                }
            };

            return (
                <div className="min-h-screen p-6 max-w-7xl mx-auto pb-32">
                    <header className="mb-8 bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-700 flex flex-col md:flex-row justify-between items-center gap-6 relative">
                        <div className="flex flex-col items-center md:items-start">
                            <h1 className="text-3xl font-bold text-white flex items-center gap-3">
                                <IconMessageCircle className="w-8 h-8 text-line" />
                                Line è¡¨æƒ…è²¼è‡ªå‹•åŒ–åŠ©æ‰‹
                            </h1>
                            <div className="mt-2 text-sm text-slate-400 font-medium flex flex-row items-center gap-2">
                                <img src={logoSrc} referrerPolicy="no-referrer" alt="Meiko Logo" className="w-8 h-8 rounded-full shadow-sm object-cover border border-slate-600" />
                                <div className="flex items-center gap-1">
                                    <a href="https://www.youtube.com/@meiko1" target="_blank" className="text-white hover:text-line hover:underline transition-colors font-bold">
                                        Meikoå¾®èª²é »é“
                                    </a>
                                    <span className="text-slate-600 mx-1">|</span>
                                    <span className="text-line font-bold">é£†é€Ÿè£½ä½œ Line è¡¨æƒ…è²¼å·¥å» </span>
                                </div>
                            </div>
                        </div>

                        <div className="flex items-center bg-slate-900 rounded-full px-6 py-2 border border-slate-700">
                            {[ { num: 1, label: 'ä¸Šå‚³ (8x5)' }, { num: 2, label: 'å»èƒŒ' }, { num: 3, label: 'æ‰“åŒ…' } ].map((s, idx) => (
                                <div key={s.num} className="flex items-center">
                                    <div className={`flex items-center gap-2 ${step >= s.num ? 'text-white' : 'text-slate-500'}`}>
                                        <div className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold transition-colors ${step >= s.num ? 'bg-line text-white' : 'bg-slate-700 text-slate-500'}`}>{step > s.num ? <IconCheckCircle className="w-4 h-4" /> : s.num}</div>
                                        <span className={`text-sm font-medium ${step >= s.num ? 'text-white' : ''}`}>{s.label}</span>
                                    </div>
                                    {idx < 2 && <div className={`w-8 h-[2px] mx-3 rounded-full ${step > s.num ? 'bg-green-600' : 'bg-slate-700'}`}></div>}
                                </div>
                            ))}
                        </div>
                    </header>

                    <div className={`transition-opacity duration-500 ${step !== 1 ? 'opacity-0 hidden' : 'opacity-100'}`}>
                        <div className="grid grid-cols-1 lg:grid-cols-5 gap-6 mb-8">
                            <div className="lg:col-span-3 bg-slate-800 rounded-3xl shadow-lg border border-slate-700 p-10 text-center">
                                <h2 className="text-2xl font-bold text-white mb-4">ä¸Šå‚³æ‚¨çš„è¡¨æƒ…è²¼åŸå§‹æª”</h2>
                                <div className="text-slate-400 mb-8 text-sm leading-relaxed max-w-3xl mx-auto bg-slate-900/50 p-4 rounded-xl border border-slate-700">
                                    <p className="mb-2 font-medium text-white">è«‹ä¸Šå‚³ 8x5 ç¶²æ ¼åœ– (JPG/PNG)ï¼Œåœ–ç‰‡éœ€è¦ç¬¦åˆä»¥ä¸‹è¦æ ¼ï¼š</p>
                                    <ul className="text-left list-none space-y-1 mb-4 pl-4 md:pl-12">
                                        <li>(1) æ•´é«”ç‚º 8 Ã— 5 ä½ˆå±€ï¼Œå…± 40 å¼µè²¼åœ–ï¼Œç¸½å°ºå¯¸ï¼š<span className="text-sky-400 font-mono">2624 Ã— 1632 px</span> (æ©«å‘)ã€‚</li>
                                        <li>(2) å»ºè­°ä½¿ç”¨ä¸‹æ–¹è¦ç¯„å¥½çš„Prompté€²è¡Œç”Ÿåœ–ï¼Œè‹¥ç™¼ç¾åœ–ç‰‡ç”Ÿæˆä¸ç¬¦åˆå°ºå¯¸ï¼Œå¯ä»¥å†æ¬¡è·ŸAIæå‡ºéœ€æ±‚ï¼Œè«‹AIä¾æ“šæŒ‡å®šçš„åƒç´ ä¿®æ”¹ã€‚</li>
                                    </ul>
                                    <p className="text-yellow-400 font-bold border-t border-slate-700 pt-3 mt-2">
                                        ğŸ’¡ å¯ä»¥åƒè€ƒä¸‹æ–¹ç”Ÿåœ–ã€AI æç¤ºè©å¤§å¸«ã€‘å…ˆç”Ÿæˆåœ–ç‰‡ï¼Œå†ä½¿ç”¨ã€Line è¡¨æƒ…è²¼è‡ªå‹•åŒ–åŠ©æ‰‹ã€‘é€²è¡ŒåŠ å·¥ã€‚
                                    </p>
                                </div>

                                <div className="relative group w-full max-w-2xl mx-auto flex flex-col items-center">
                                    <div className="border-2 border-dashed border-slate-600 rounded-2xl flex flex-col items-center justify-center bg-slate-900 group-hover:border-line group-hover:bg-slate-800 transition-all cursor-pointer overflow-hidden relative w-full" style={{ height: originalSheet ? 'auto' : '16rem', padding: originalSheet ? '20px' : '0' }}>
                                        <input type="file" accept="image/*" onChange={handleUpload} className="absolute inset-0 opacity-0 cursor-pointer z-20" />
                                        {originalSheet ? (
                                            <div 
                                                className="relative overflow-hidden shadow-2xl border-2 border-slate-500/50 flex items-center justify-center"
                                                style={{
                                                    width: 'fit-content',
                                                    height: 'auto',
                                                    maxWidth: '100%',
                                                    maxHeight: '60vh'
                                                }}
                                            >
                                                <div 
                                                    style={{
                                                        position: 'relative',
                                                    }}
                                                >
                                                    <img 
                                                        src={originalSheet.src} 
                                                        style={{ 
                                                            display: 'block',
                                                            maxWidth: '100%',
                                                            maxHeight: '60vh',
                                                            transform: `translate(${gridAdj.xPercent}%, ${gridAdj.yPercent}%) scale(${gridAdj.scale})`,
                                                            transformOrigin: 'center center',
                                                            transition: 'transform 0.1s linear'
                                                        }} 
                                                        alt="Original" 
                                                    />
                                                    
                                                    <div className="absolute inset-0 align-grid w-full h-full z-10 opacity-70 pointer-events-none"></div>
                                                </div>
                                            </div>
                                        ) : (
                                            <div className="flex flex-col items-center justify-center z-10 pointer-events-none py-10 w-full h-full">
                                                <div className="w-16 h-16 bg-slate-800 text-line rounded-2xl flex items-center justify-center mb-4 shadow-sm group-hover:scale-110 group-hover:bg-white transition-all border border-slate-700">
                                                    <IconUpload className="w-8 h-8" />
                                                </div>
                                                <span className="bg-white text-slate-900 px-6 py-2 rounded-full font-bold shadow-md group-hover:shadow-lg transition-all">é¸æ“‡æª”æ¡ˆ</span>
                                                <span className="text-xs text-slate-500 mt-3">æˆ–æ˜¯å°‡åœ–ç‰‡æ‹–æ›³è‡³æ­¤</span>
                                            </div>
                                        )}
                                    </div>
                                    
                                    {originalSheet && (
                                        <div className="mt-4 bg-slate-900 p-4 rounded-xl border border-slate-700 space-y-4 w-full">
                                            <div className="flex items-center justify-between text-white font-bold text-sm mb-2 border-b border-slate-700 pb-2">
                                                <span className="flex items-center gap-2"><IconMove className="w-4 h-4"/> ç¶²æ ¼å°ä½ (Grid Alignment)</span>
                                                <button onClick={() => setGridAdj({xPercent:0, yPercent:0, scale:1.0})} className="text-xs text-slate-400 hover:text-white underline">é‡ç½®</button>
                                            </div>
                                            
                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                                <div className="space-y-1">
                                                    <div className="flex justify-between text-xs text-slate-400"><span>æ°´å¹³ç§»å‹• (X%)</span><span>{gridAdj.xPercent}%</span></div>
                                                    <input type="range" min="-20" max="20" step="0.5" value={gridAdj.xPercent} onChange={(e) => setGridAdj({...gridAdj, xPercent: Number(e.target.value)})} className="w-full h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer"/>
                                                </div>
                                                <div className="space-y-1">
                                                    <div className="flex justify-between text-xs text-slate-400"><span>å‚ç›´ç§»å‹• (Y%)</span><span>{gridAdj.yPercent}%</span></div>
                                                    <input type="range" min="-20" max="20" step="0.5" value={gridAdj.yPercent} onChange={(e) => setGridAdj({...gridAdj, yPercent: Number(e.target.value)})} className="w-full h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer"/>
                                                </div>
                                                <div className="space-y-1">
                                                    <div className="flex justify-between text-xs text-slate-400"><span>ç¸®æ”¾ (Zoom)</span><span>{Math.round(gridAdj.scale * 100)}%</span></div>
                                                    <input type="range" min="0.8" max="1.2" step="0.005" value={gridAdj.scale} onChange={(e) => setGridAdj({...gridAdj, scale: Number(e.target.value)})} className="w-full h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer"/>
                                                </div>
                                            </div>
                                            <p className="text-[10px] text-slate-500 mt-2">* æç¤ºï¼šè‹¥ç´…æ¡†æ²’æœ‰å°æº–ï¼Œè«‹å…ˆèª¿æ•´ç¸®æ”¾ (Zoom)ï¼Œå†å¾®èª¿æ°´å¹³/å‚ç›´ä½ç½®ã€‚</p>
                                        </div>
                                    )}
                                </div>
                                {originalSheet && (
                                    <button onClick={performSlice} className="mt-8 bg-line hover:bg-orange-600 text-white px-12 py-4 rounded-xl font-bold shadow-lg shadow-orange-900 transition-all btn-press flex items-center justify-center gap-3 mx-auto text-lg">
                                        {isProcessing ? <IconLoader /> : <IconScissors />} é–‹å§‹åˆ‡å‰² (8x5)
                                    </button>
                                )}
                            </div>

                            <div className="lg:col-span-2 bg-slate-800/80 p-6 rounded-3xl border border-slate-700 h-fit space-y-6 text-slate-300">
                                <h3>ã€Line è¡¨æƒ…è²¼è‡ªå‹•åŒ–åŠ©æ‰‹ æ­¥é©Ÿèªªæ˜ã€‘</h3>
                                <div className="space-y-6 text-sm text-slate-400">
                                    <div>
                                        <div className="font-bold text-line text-lg mb-2">Step 1ï¼šå…ˆæŠŠä½ çš„è²¼åœ–ã€Œç”Ÿã€å‡ºä¾†ï¼</div>
                                        <p className="leading-relaxed">é‚„æ²’æœ‰åœ–ç‰‡ï¼Ÿå®Œå…¨æ²’å•é¡Œï½<br/>
                                        ç›´æ¥ä½¿ç”¨ä¸‹æ–¹ Meikoå¹«å¤§å®¶è¨­è¨ˆçš„ã€AI æç¤ºè©å¤§å¸«ã€‘ï¼ŒæŒ‘é¸é©åˆçš„promptå¾Œï¼Œç”Ÿæˆåœ–ç‰‡(Promptå…§æ©˜è‰²æ–‡å­—éƒ½æ˜¯å¯ä»¥ä¿®æ”¹çš„)ã€‚åŠ é»ä½ çš„å‰µæ„èª¿å‘³ï¼Œç”¨ Gemini Nano Banana Pro / ChatGPT ...ç­‰AIå·¥å…· å°±èƒ½ç”Ÿæˆè¶…å¯æ„›è²¼åœ–ç´ æï¼</p>
                                    </div>
                                    
                                    <div>
                                        <div className="font-bold text-line text-lg mb-2">Step 2ï¼šç”¨ã€ŠLINE è¡¨æƒ…è²¼è‡ªå‹•åŒ–åŠ©æ‰‹ã€‹ä¸€éµæå®šåˆ‡åœ–ï¼‹å»èƒŒï¼</div>
                                        <p className="mb-2">ä¸‹è¼‰å‰è¨˜å¾—å…ˆåšä¸‰ä»¶å°äº‹ï¼š</p>
                                        <ul className="space-y-3 pl-2">
                                            <li className="border-l-2 border-slate-600 pl-3">
                                                <span className="font-bold text-white block mb-1">(1) ç¶²æ ¼å°ä½æŠ€å·§</span>
                                                å¦‚æœ AI ç”Ÿæˆçš„åœ–ç¨å¾®æ­ªæ–œï¼Œè«‹ç”¨å·¦å´çš„æ»‘æ¡¿å¾®èª¿ X/Y è»¸èˆ‡ç¸®æ”¾ã€‚
                                            </li>
                                            <li className="border-l-2 border-slate-600 pl-3">
                                                <span className="font-bold text-white block mb-1">(2) é¸æ“‡ tab å°é¢åœ–</span>
                                                æŒ‘ä¸€å¼µæœ€èƒ½ä»£è¡¨ä½ è§’è‰²éˆé­‚çš„å°é¢åœ–ï¼ŒæŒ‰ä¸€ä¸‹è©²åœ–ä¸‹æ–¹çš„ã€ŒtabæŒ‰éˆ•ã€å°±è¨­å®šå®Œæˆï¼Œä¸‹è¼‰æ™‚æœƒè‡ªå‹•åŒ…å«é€™å¼µåœ–ã€‚
                                            </li>
                                            <li className="border-l-2 border-slate-600 pl-3">
                                                <span className="font-bold text-white block mb-1">(3) è¨­å®šæª”åèµ·å§‹ç·¨è™Ÿ</span>
                                                å¦‚æœä½ æ­£åœ¨ç”Ÿç”¢ç¬¬äºŒçµ„è²¼åœ–ï¼Œå¯ä»¥ä¿®æ”¹èµ·å§‹ç·¨è™Ÿ (ä¾‹å¦‚æ”¹æˆ 41)ï¼Œé€™æ¨£ä¸‹è¼‰å¾Œçš„æª”åå°±æœƒè‡ªå‹•æ’å¥½ (041.png...)ï¼Œå®Œå…¨ä¸æœƒæ’è™Ÿ âœ¨
                                            </li>
                                        </ul>
                                    </div>
                                    
                                    <div>
                                        <div className="font-bold text-line text-lg mb-2">Step 3ï¼šåˆ° LINE Creators Market ä¸€éµä¸Šå‚³ï¼</div>
                                        <p>æ‰“é–‹ <a href="https://creator.line.me/zh-hant/" target="_blank" rel="noopener noreferrer" className="text-orange-400 underline hover:text-white font-bold transition-colors">Line Creators Market</a>ï¼Œå°‡ä¸‹è¼‰çš„æ•´åŒ…å£“ç¸®æª”ç›´æ¥ä¸Šå‚³å³å¯ï½</p>
                                        <p className="text-xs text-slate-500 mt-3 pt-3 border-t border-slate-700">
                                            æé†’ï¼šå®Œæˆåˆ†å‰²å»èƒŒå¾Œçš„è²¼åœ–ï¼Œä¹Ÿå¯ä»¥æ”¾åœ¨å…¶ä»–ç¤¾ç¾¤å·¥å…·å…§ä½¿ç”¨ï¼Œä¾‹å¦‚ï¼šIGã€Messengerã€WhatsAPPã€Telegramã€Discord.....ç­‰ç­‰ã€‚
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="bg-slate-800 rounded-3xl shadow-lg border border-slate-700 p-6 mb-8">
                            <div className="flex items-center justify-between mb-4">
                                <h3 className="font-bold text-lg text-white flex items-center gap-2"><IconWand2 className="w-5 h-5 text-line"/> AI æç¤ºè©å¤§å¸« (8x5 ç‰ˆ)</h3>
                                <button onClick={() => setShowPromptGuide(!showPromptGuide)} className="text-xs text-slate-400 hover:text-white flex items-center gap-1">
                                    {showPromptGuide ? "éš±è—" : "å±•é–‹"} <IconChevronDown className={`w-3 h-3 transition-transform ${showPromptGuide ? 'rotate-180' : ''}`} />
                                </button>
                            </div>
                            <div className={`transition-all duration-300 ${showPromptGuide ? 'opacity-100' : 'opacity-50 grayscale'}`}>
                                <div className="p-4 bg-slate-900 border border-slate-700 rounded-xl mb-4 space-y-6">
                                    
                                    {/* 1. å…§å®¹æ¨¡å¼é¸æ“‡ */}
                                    <div className="space-y-2">
                                        <span className="text-xs font-bold text-slate-400 block">1. å…§å®¹æ¨¡å¼ï¼š</span>
                                        <div className="flex gap-2 flex-wrap">
                                            {PROMPT_MODES.map((mode) => (
                                                <button 
                                                    key={mode.id} 
                                                    onClick={() => setPromptMode(mode.id)}
                                                    className={`px-3 py-2 rounded-lg text-xs font-bold transition-all border flex items-center gap-2 ${promptMode === mode.id ? 'bg-orange-600 text-white border-orange-500' : 'bg-slate-800 text-slate-400 border-slate-700 hover:border-slate-500'}`}
                                                >
                                                    {mode.icon} {mode.label}
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    {/* 2. è§’è‰²é¸æ“‡ */}
                                    {promptMode !== 'text_only' && (
                                        <div className="space-y-2 animate-fade-in">
                                            <span className="text-xs font-bold text-slate-400 block">2. é¸æ“‡ä¸»è§’ï¼š</span>
                                            <div className="flex gap-2 flex-wrap">
                                                {CHAR_TYPES.map((char) => (
                                                    <button 
                                                        key={char.id} 
                                                        onClick={() => setCharType(char.id)}
                                                        className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all border ${charType === char.id ? 'bg-purple-600 text-white border-purple-500' : 'bg-slate-800 text-slate-400 border-slate-700 hover:border-slate-500'}`}
                                                    >
                                                        {char.label}
                                                    </button>
                                                ))}
                                            </div>
                                            {charType === 'custom' && (
                                                <input 
                                                    type="text" 
                                                    placeholder="è«‹è¼¸å…¥è‡ªè¨‚è§’è‰²æè¿° (ä¾‹å¦‚ï¼šæˆ´å¢¨é¡çš„é³³æ¢¨)" 
                                                    value={customCharDesc}
                                                    onChange={(e) => setCustomCharDesc(e.target.value)}
                                                    className="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-xs text-white focus:border-line outline-none mt-2"
                                                />
                                            )}
                                        </div>
                                    )}

                                    {/* 3. é¢¨æ ¼é¸æ“‡ */}
                                    <div className="space-y-2">
                                        <span className="text-xs font-bold text-slate-400 block">3. é¸æ“‡ç•«é¢¨ï¼š</span>
                                        <div className="flex gap-2 flex-wrap">
                                            {PROMPT_STYLES.map((style) => (
                                                <button key={style.id} onClick={() => setActiveStyle(style.id)} className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all border ${activeStyle === style.id ? 'bg-purple-600 text-white border-purple-500' : 'bg-slate-800 text-slate-400 border-slate-700 hover:border-slate-500'}`}>{style.label}</button>
                                            ))}
                                        </div>
                                    </div>

                                    {/* 4. é…è‰²é¢¨æ ¼ (New!) */}
                                    <div className="space-y-2">
                                        <span className="text-xs font-bold text-slate-400 block">4. é…è‰²é¢¨æ ¼ï¼š</span>
                                        <div className="flex gap-2 flex-wrap">
                                            {PROMPT_COLORS.map((color) => (
                                                <button 
                                                    key={color.id} 
                                                    onClick={() => setActiveColor(color.id)}
                                                    className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all border flex items-center gap-2 ${activeColor === color.id ? 'bg-pink-600 text-white border-pink-500' : 'bg-slate-800 text-slate-400 border-slate-700 hover:border-slate-500'}`}
                                                >
                                                    <IconPalette className="w-3 h-3"/> {color.label}
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    {/* 5. åˆ†é¡é¸æ“‡ */}
                                    <div className="space-y-2">
                                        <span className="text-xs font-bold text-slate-400 block">5. é¸æ“‡å…§å®¹åˆ†é¡ (åƒè€ƒå‹•ä½œ)ï¼š</span>
                                        <div className="flex gap-2 flex-wrap">
                                            {Object.entries(PROMPT_THEMES).map(([key, theme]) => (
                                                <button key={key} onClick={() => setActiveTheme(key)} className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all border ${activeTheme === key ? 'bg-orange-600 text-white border-orange-500' : 'bg-slate-800 text-slate-400 border-slate-700 hover:border-slate-500'}`}>{theme.label}</button>
                                            ))}
                                        </div>
                                    </div>

                                </div>
                                <PromptDisplay />
                                <div className="mt-4 flex justify-end">
                                    <button onClick={handleCopyPrompt} className={`px-6 py-3 rounded-xl font-bold flex items-center gap-2 transition-all ${copySuccess ? 'bg-orange-600 text-white' : 'bg-white text-slate-900 hover:bg-slate-200'}`}>
                                        {copySuccess ? <IconCheckCircle className="w-5 h-5"/> : <IconCopy className="w-5 h-5"/>}
                                        {copySuccess ? "å·²è¤‡è£½æˆåŠŸï¼" : "è¤‡è£½ Prompt"}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className={`step-card bg-slate-800 rounded-3xl shadow-lg border border-slate-700 p-8 mb-8 ${step !== 2 && 'hidden'}`}>
                        <div className="flex flex-col xl:flex-row justify-between items-start gap-8">
                            <div className={`transition-all duration-500 ${showSettings ? 'w-full xl:w-2/3' : 'w-full'}`}>
                                <div className={`grid gap-4 ${showSettings ? 'grid-cols-5 md:grid-cols-5' : 'grid-cols-5 md:grid-cols-8'}`}>
                                    {slicedPieces.map((p) => (
                                        <div key={p.id} className="aspect-square bg-slate-900 rounded-xl border border-slate-700 p-2 flex items-center justify-center">
                                            <img src={p.previewUrl} className="w-full h-full object-contain" />
                                        </div>
                                    ))}
                                </div>
                            </div>
                            <div className={`transition-all duration-500 bg-slate-900 rounded-2xl border border-slate-700 overflow-hidden ${showSettings ? 'w-full xl:w-1/3 opacity-100' : 'w-full xl:w-12 h-16 xl:h-auto opacity-80 cursor-pointer hover:bg-slate-800'}`}>
                                <div onClick={() => setShowSettings(!showSettings)} className="p-6 flex items-center justify-between cursor-pointer">
                                    <div className={`flex items-center gap-2 font-bold text-white whitespace-nowrap ${!showSettings && 'xl:hidden'}`}>
                                        <IconSettings className="w-5 h-5 text-line"/> å•Ÿç”¨æ™ºèƒ½å»èƒŒ
                                    </div>
                                    <div className={`hidden xl:flex flex-col items-center gap-4 py-4 ${showSettings && 'hidden'}`}>
                                        <IconSettings className="w-6 h-6 text-slate-400"/>
                                        <span className="text-[10px] text-slate-500 writing-vertical-lr tracking-widest">é»æ“Šå±•é–‹è¨­å®š</span>
                                    </div>
                                    <div className={`relative inline-flex items-center cursor-pointer ${!showSettings && 'xl:hidden'}`}>
                                        <input type="checkbox" checked={autoRemoveBg} onChange={(e)=> {e.stopPropagation(); setAutoRemoveBg(e.target.checked)}} className="sr-only peer"/>
                                        <div className="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-line"></div>
                                    </div>
                                </div>
                                <div className={`px-6 pb-6 space-y-6 ${!showSettings && 'hidden'}`}>
                                    {autoRemoveBg && (
                                        <div className="space-y-6 animate-fade-in">
                                            <div>
                                                <div className="flex justify-between text-xs text-slate-400 mb-2 font-medium"><span>å¿«é€Ÿè¨­å®š (Presets)</span></div>
                                                <div className="grid grid-cols-3 gap-2">
                                                    <button onClick={()=>applyPreset('green')} className={`px-3 py-3 rounded-xl border text-xs font-bold flex flex-col items-center justify-center gap-2 transition ${targetColorHex === '#00FF00' ? 'bg-orange-900/30 text-orange-400 border-orange-700 shadow-sm' : 'bg-slate-900 text-slate-400 border-slate-700 hover:border-orange-800'}`}><div className="w-4 h-4 bg-green-500 rounded-full"></div> <span>ç¶ å¹•å»èƒŒ</span></button>
                                                    <button onClick={()=>applyPreset('white')} className={`px-3 py-3 rounded-xl border text-xs font-bold flex flex-col items-center justify-center gap-2 transition ${targetColorHex === '#FFFFFF' ? 'bg-slate-200 text-slate-900 border-slate-400 shadow-sm' : 'bg-slate-900 text-slate-400 border-slate-700 hover:border-slate-500'}`}><IconSun className="w-4 h-4" /> <span>ç™½åº•å»èƒŒ</span></button>
                                                    <button onClick={()=>applyPreset('black')} className={`px-3 py-3 rounded-xl border text-xs font-bold flex flex-col items-center justify-center gap-2 transition ${targetColorHex === '#000000' ? 'bg-slate-800 text-white border-slate-600 shadow-md' : 'bg-slate-900 text-slate-400 border-slate-700 hover:border-slate-500'}`}><IconMoon className="w-4 h-4" /> <span>é»‘åº•å»èƒŒ</span></button>
                                                </div>
                                            </div>
                                            <button onClick={()=>setShowAdvanced(!showAdvanced)} className="w-full flex items-center justify-between text-xs text-slate-400 hover:text-white pt-2 border-t border-slate-700">
                                                <span className="flex items-center gap-1"><IconSettings className="w-3 h-3"/> é¡¯ç¤ºé€²éšè¨­å®š</span>
                                                <IconChevronDown className={`w-3 h-3 transition-transform ${showAdvanced ? 'rotate-180' : ''}`} />
                                            </button>
                                            <div className={`collapse-content ${showAdvanced ? 'collapse-open' : ''}`}>
                                                <div className="pt-4 space-y-4">
                                                    <div className="bg-slate-800 p-3 rounded-lg border border-slate-600 shadow-sm">
                                                        <div className="flex justify-between text-[10px] text-slate-400 mb-1">
                                                            <span className="flex items-center gap-1"><IconCrop className="w-3 h-3"/> è£åˆ‡ç¸®æ”¾ (Zoom)</span>
                                                            <span className="font-bold text-line">{Math.round((zoomLevel) * 100)}%</span>
                                                        </div>
                                                        <input type="range" min="1.00" max="1.50" step="0.01" value={zoomLevel} onChange={(e)=>setZoomLevel(Number(e.target.value))} className="w-full h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer"/>
                                                        <div className="text-[10px] text-slate-500 mt-1">å»ºè­°ä¿æŒ 100% æ»¿ç‰ˆï¼Œé™¤éæ–‡å­—è¢«åˆ‡åˆ°</div>
                                                    </div>
                                                    <div className="bg-slate-800 p-3 rounded-lg border border-slate-600 shadow-sm">
                                                        <div className="flex justify-between text-[10px] text-slate-400 mb-1"><span>ç›®æ¨™é¡è‰²</span><span className="font-mono">{targetColorHex}</span></div>
                                                        <input type="color" value={targetColorHex} onChange={(e)=>setTargetColorHex(e.target.value)} className="w-full h-8 rounded cursor-pointer border border-slate-600 p-0" />
                                                    </div>
                                                    <div className="bg-slate-800 p-3 rounded-lg border border-slate-600 shadow-sm">
                                                        <div className="flex justify-between text-[10px] text-slate-400 mb-1"><span>è‰²å½©å®¹è¨±åº¦ (Tolerance)</span><span>{colorTolerance}</span></div>
                                                        <input type="range" min="1" max="100" value={colorTolerance} onChange={(e)=>setColorTolerance(Number(e.target.value))} className="w-full h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer"/>
                                                    </div>
                                                    <div className="bg-slate-800 p-3 rounded-lg border border-slate-600 shadow-sm">
                                                        <div className="flex justify-between text-[10px] text-slate-400 mb-1"><span>é‚Šç·£æŸ”åŒ– (Smoothness)</span><span>{smoothness}</span></div>
                                                        <input type="range" min="0" max="10" step="1" value={smoothness} onChange={(e)=>setSmoothness(Number(e.target.value))} className="w-full h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer"/>
                                                    </div>
                                                    <div className="flex items-center justify-between bg-slate-800 p-3 rounded-lg border border-slate-600 shadow-sm">
                                                        <span className="text-[10px] text-slate-400">æº¢è‰²å»é™¤ (Despill)</span>
                                                        <input type="checkbox" checked={despill} onChange={(e)=>setDespill(e.target.checked)} className="accent-orange-500 w-4 h-4"/>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                        <div className="flex justify-center gap-4 pt-8 border-t border-slate-700 mt-6">
                            <button onClick={()=>setStep(1)} className="px-6 py-3 rounded-xl font-bold text-slate-400 bg-slate-900 hover:bg-slate-700 hover:text-white transition">é‡æ–°ä¸Šå‚³</button>
                            <button onClick={performProcessing} disabled={isProcessing} className="bg-line hover:bg-orange-600 text-white px-12 py-3 rounded-xl font-bold shadow-lg shadow-orange-900 transition-all btn-press flex items-center justify-center gap-2 min-w-[240px]">
                                {isProcessing ? <><IconLoader /><span>è™•ç†ä¸­ ({processedCount}/{TOTAL_ITEMS})</span></> : <><IconEraser />åŸ·è¡Œå»èƒŒ</>}
                            </button>
                        </div>
                    </div>

                    <div className={`step-card bg-slate-800 rounded-3xl shadow-lg border border-slate-700 p-8 mb-8 ${step !== 3 && 'hidden'}`}>
                         <div className="flex flex-col xl:flex-row justify-between items-start mb-8 gap-6 pb-6 border-b border-slate-700">
                            <div className="flex-1 space-y-4">
                                <div>
                                    <h2 className="text-2xl font-bold text-white flex items-center gap-2 mb-2"><IconCheckCircle className="text-line"/>è¨­å®šèˆ‡æ‰“åŒ…</h2>
                                    <p className="text-slate-400 text-sm">è«‹å‹¾é¸ä¸»åœ–(Main)èˆ‡æ¨™ç±¤åœ–(Tab) <span className="text-xs text-slate-500">(å¯é¸)</span>ã€‚</p>
                                </div>
                                
                                <div className="bg-yellow-500/10 border border-yellow-500/30 p-5 rounded-xl text-lg text-yellow-200 max-w-3xl">
                                    <div className="font-bold flex items-center gap-2 mb-3 text-yellow-400 text-xl"><IconInfo className="w-6 h-6"/> ä¸‹è¼‰å‰æ³¨æ„äº‹é …ï¼š</div>
                                    <ul className="list-disc pl-6 space-y-3 opacity-90 text-base md:text-lg">
                                        <li>é¸æ“‡ <span className="text-white font-bold bg-yellow-600/30 px-1 rounded">tab å°é¢åœ–</span>ï¼šæŒ‘ä¸€å¼µæœ€èƒ½ä»£è¡¨ä½ è§’è‰²éˆé­‚çš„å°é¢åœ–ï¼ŒæŒ‰ä¸€ä¸‹å°±è¨­å®šå®Œæˆï¼</li>
                                        <li>è¨­å®š <span className="text-white font-bold bg-yellow-600/30 px-1 rounded">æª”åèµ·å§‹ç·¨è™Ÿ</span>ï¼šç¬¬äºŒçµ„è²¼åœ–è«‹æ”¹ç‚º 13ï¼Œä¸‹è¼‰å¾Œ 40 å¼µè²¼åœ–è‡ªå‹•æ’éšŠï¼Œå®Œå…¨ä¸æ’è™Ÿ âœ¨</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div className="w-full xl:w-auto flex flex-row items-stretch gap-3 self-end xl:self-center h-full pt-4 xl:pt-0">
                                <div className="bg-slate-900 px-4 py-2 rounded-xl border border-slate-600 flex flex-col justify-center min-w-[140px]">
                                    <span className="text-xs font-bold text-slate-400 flex items-center gap-1 mb-1"><IconHash className="w-3 h-3"/> èµ·å§‹ç·¨è™Ÿ</span>
                                    <input type="number" min="1" value={startNumber} onChange={(e) => setStartNumber(Math.max(1, parseInt(e.target.value) || 1))} className="w-full bg-slate-800 border border-slate-600 text-white rounded-lg text-center font-bold text-lg focus:ring-2 focus:ring-orange-500 outline-none py-1" />
                                </div>
                                <button onClick={downloadZip} className="flex-1 bg-line hover:bg-orange-600 text-white px-8 py-4 rounded-xl font-bold shadow-lg transition-all btn-press flex items-center justify-center gap-2 text-lg whitespace-nowrap"><IconDownload className="w-6 h-6" /> ä¸‹è¼‰å®Œæ•´ ZIP</button>
                            </div>
                        </div>

                        <div className="grid grid-cols-2 md:grid-cols-5 lg:grid-cols-8 gap-4">
                            {finalImages.map((img, idx) => (
                                <div key={img.id} className="bg-slate-900 rounded-xl border border-slate-700 p-2 hover:border-orange-500 hover:shadow-md transition-all">
                                    <div className="aspect-square grid-bg rounded-lg flex items-center justify-center overflow-hidden border border-slate-700 mb-2"><img src={img.dataUrl} className="w-full h-full object-contain" /></div>
                                    <div className="text-center text-xs font-bold text-slate-400 mb-2 bg-slate-800 rounded py-1">{getFileName(idx)}.png</div>
                                    <div className="space-y-1">
                                        <label className="flex items-center gap-1 cursor-pointer group justify-center">
                                            <input type="radio" name="tab_select" checked={tabId === img.id} onChange={() => setTabId(img.id)} className="hidden custom-radio"/>
                                            <div className={`text-[10px] border rounded px-3 py-1 flex items-center gap-1 justify-center transition-all w-full ${tabId === img.id ? 'bg-orange-900/40 border-line text-line font-bold' : 'bg-slate-800 border-slate-600 text-slate-500 group-hover:bg-slate-700 group-hover:border-slate-500'}`}><IconTag className="w-3 h-3" /> Tab</div>
                                        </label>
                                    </div>
                                </div>
                            ))}
                        </div>
                        <div className="text-center mt-10"><button onClick={()=>setStep(1)} className="text-slate-500 hover:text-slate-300 text-sm font-medium transition-colors underline">è™•ç†ä¸‹ä¸€å¼µåŸå§‹åœ–</button></div>
                    </div>
                    
                    <footer className="text-center mt-12 mb-8 space-y-4">
                        <div className="flex flex-col md:flex-row justify-start items-center gap-4 pl-4">
                            <a href="https://meikochang.github.io/line-sticker-factory/" target="_blank" className="bg-line-official hover:bg-[#05b34c] text-white text-sm font-bold px-6 py-3 rounded-full transition-all shadow-lg flex items-center gap-2">
                                <span>LINE è²¼åœ–è‡ªå‹•åŒ–åŠ©æ‰‹</span>
                                <IconExternalLink className="w-4 h-4"/> 
                            </a>
                             <a href="https://www.youtube.com/@meiko1" target="_blank" className="bg-youtube hover:bg-[#CC0000] text-white text-sm font-bold px-6 py-3 rounded-full transition-all shadow-lg flex items-center gap-2">
                                <span>Meikoå¾®èª²é »é“</span>
                                <IconYoutube className="w-4 h-4"/> 
                            </a>
                        </div>

                        <div className="text-slate-500 text-sm">
                             Â© 2025 Meiko å¾®èª²é »é“ | LINE Emoji Factory
                            <div className="mt-1">
                                æ­¡è¿å‰å¾€ <a href="https://www.youtube.com/@meiko1" target="_blank" rel="noreferrer" className="text-line font-bold hover:underline">ã€Meikoå¾®èª²é »é“ã€‘</a> å­¸ç¿’æ›´å¤š AI æ‡‰ç”¨æŠ€å·§ã€‚
                            </div>
                        </div>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
